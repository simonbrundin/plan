name: CI - Frontend
run-name: CI - Frontend
on:
  push:
    branches:
      - main
    paths:
      - "frontend/**"
jobs:
  ci-frontend:
    permissions:
      contents: write
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    services:
      dagger-engine:
        image: registry.dagger.io/engine:v0.18.17
        options: --privileged
        volumes:
          - /run/dagger:/run/dagger
          - /var/lib/dagger:/var/lib/dagger
    steps:
      - name: Checkout source repo
        uses: actions/checkout@v3
        with:
          path: source-repo

      - name: Checkout deployment pipeline
        uses: actions/checkout@v3
        with:
          repository: simonbrundin/deployment-pipeline
          token: ${{ secrets.GITHUB_TOKEN }}
          path: deployment-pipeline
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      # - name: Clean npm cache
      #   run: npm cache clean --force
      #   working-directory: source-repo/frontend

      # - name: Remove lockfiles
      #   run: rm -f package-lock.json bun.lockb
      #   working-directory: source-repo/frontend

      - name: Install devDependencies for semantic-release
        run: npm install --only=dev --ignore-scripts --legacy-peer-deps
        working-directory: source-repo/frontend

      - name: Run semantic-release
        id: semantic-release
        run: npx semantic-release
        working-directory: source-repo/frontend
        env:
          GITHUB_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}

      - name: Get latest version tag
        id: get-version
        run: |
          cd source-repo
          VERSION=$(git describe --tags --match "frontend-*" --abbrev=0 | sed 's/frontend-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest version: $VERSION"

      - name: Download Dagger CLI
        run: |
          curl -L https://github.com/dagger/dagger/releases/download/v0.18.17/dagger_v0.18.17_linux_amd64.tar.gz | tar -xz -C /usr/local/bin
          chmod +x /usr/local/bin/dagger

      - name: Run Dagger CI
        run: |
          cd deployment-pipeline/dagger-modules/pipeline
          dagger call ci \
            --image-name ${{ github.event.repository.name }} \
            --registry-address ghcr.io/simonbrundin \
            --source-dir $GITHUB_WORKSPACE/source-repo/frontend\
            --tag frontend-${{ steps.get-version.outputs.version }} \
            --username simonbrundin \
            --secret ${{ secrets.REGISTRY_PASSWORD }} \
            --multiArch
        env:
          DAGGER_CLOUD_TOKEN: ${{ secrets.DAGGER_CLOUD_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

      # - name: Commit changes
      #   run: |
      #     cd source-repo
      #     git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
      #     git config --local user.name "github-actions[bot]"
      #     git add .
      #     git commit -m "Release ${{ env.TAG }} [skip ci]" || exit 0
      #
      # - name: Push changes
      #   uses: ad-m/github-push-action@master
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     branch: ${{ github.ref }}
      #     directory: source-repo
