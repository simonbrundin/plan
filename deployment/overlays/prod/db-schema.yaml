apiVersion: db.atlasgo.io/v1alpha1
kind: AtlasSchema
metadata:
  name: atlasschema-plan
spec:
  urlFrom:
    secretKeyRef:
      key: uri
      name: plan-db-app
  schema:
    sql: |
      CREATE TABLE "users" (
        "id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
        "email" VARCHAR(40) NOT NULL UNIQUE,
        "first_name" VARCHAR(16),
        "last_name" VARCHAR(40),
        "created" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY("id")
      );




      CREATE TABLE "tasks" (
        "id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
        "title" VARCHAR(64),
        "created" TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
        "finished" TIMESTAMPTZ,
        PRIMARY KEY("id")
      );




      CREATE TABLE "users_tasks" (
        "user_id" INTEGER NOT NULL,
        "task_id" INTEGER NOT NULL,
        PRIMARY KEY("user_id", "task_id")
      );




      CREATE TABLE "task_relations" (
        "parent_id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
        "child_id" INTEGER NOT NULL,
        PRIMARY KEY("parent_id", "child_id")
      );



      ALTER TABLE "users_tasks"
      ADD FOREIGN KEY("user_id") REFERENCES "users"("id")
      ON UPDATE NO ACTION ON DELETE NO ACTION;
      ALTER TABLE "users_tasks"
      ADD FOREIGN KEY("task_id") REFERENCES "tasks"("id")
      ON UPDATE NO ACTION ON DELETE NO ACTION;
      ALTER TABLE "task_relations"
      ADD FOREIGN KEY("parent_id") REFERENCES "tasks"("id")
      ON UPDATE NO ACTION ON DELETE NO ACTION;
      ALTER TABLE "task_relations"
      ADD FOREIGN KEY("child_id") REFERENCES "tasks"("id")
      ON UPDATE NO ACTION ON DELETE NO ACTION;
