apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: test
  namespace: plan-pipeline
spec:
  requestedFreight: []   # måste alltid finnas
  subscriptions:
    warehouse: frontend-warehouse
  freightConstraints:
    - sources:
        - kind: GitRepository
          name: frontend-warehouse
        - kind: Image
          name: frontend-warehouse
  promotionTemplate:
    spec:
      approvals:
        auto: true
      steps:
        # Rendera overlay/template-ephemeral med rätt image
        - uses: render.kustomize
          as: render-test
          with:
            path: deployment/overlays/template-ephemeral
            images:
              - name: ghcr.io/simonbrundin/plan/frontend
                newTag: ${{ freight.frontend-warehouse.image.tag }}

        # Git apply kan "markera" promotion så att CI kör tester
        - uses: git.apply
          with:
            repoURL: https://github.com/simonbrundin/plan.git
            branch: main
            path: .kargo/promotions/test  # dummy fil för att trigga GH Action/Dagger
